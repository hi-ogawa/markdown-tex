<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Markdown Tex</title>
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,maximum-scale=1,user-scalable=no">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>

<!-- css -->
<style>
  *, *::before, *::after {
    box-sizing: border-box;
    margin: 0; border: 0;
  }
  html, body {
    height: 100%;
    font-family: Roboto;
  }
  #root {
    height: 100%;
    display: flex;
    flex-direction: row;
  }
  #input {
    flex: 1 0 50%;
    overflow-x: auto;
    border-right: 1px solid #aaa;
  }
  #input > .CodeMirror {
    height: 100%;
  }
  #output {
    flex: 1 0 50%;
    overflow-y: auto;
    padding: 10px;
  }
  #settings-button {
    position: absolute;
    top: 6px; right: 6px;
    cursor: pointer;
  }
  #settings {
    position: absolute;
    background: #f8f8f8;
    width: 35%; min-width: 350px;
    top: 35%; left: 50%; transform: translate(-50%, -50%);
    padding: 14px;
    z-index: 6;  /* codemirror use z-Index 5 */
    border-radius: 4px;
    box-shadow: 0 2px 1px 0px #eee;
    display: flex;
    flex-direction: column;
  }
  #settings[hidden] {
    display: none;
  }
  #settings > #menu {
    font-size: 22px;
    font-weight: 300;
    margin: 0 10px 6px 10px;
  }
  #settings > ul > li {
    margin-bottom: 6px;
  }
  #settings > ul > li > span {
    color: #44e;
    text-decoration: underline;
    cursor: pointer;
  }
</style>

<!-- DOM -->
<div id="root">
  <div id="input"></div>
  <div id="output" class="markdown-body"></div>
  <div id="settings-button" onclick="var s = document.querySelector('#settings'); s.hidden = !s.hidden">
    <i class="material-icons">settings</i>
  </div>
  <div id="settings" hidden>
    <div id="menu">Menu</div>
    <ul>
      <li id="current-gist"><span>Current Gist</span></li>
      <li id="open-new-gist"><span>Open New Gist</span></li>
      <li id="setup-access-token">
        <span>Setup Access Token</span> or
        <a target='_blank' href="https://github.com/settings/tokens/new?scopes=gist&description=Markdown%20Tex">Create</a>
      </li>
    </ul>
  </div>
</div>

<!-- lib: lodash -->
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>

<!-- lib: showdown -->
<script src="https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js"></script>

<!-- lib: https://github.com/sindresorhus/github-markdown-css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css">

<!-- lib: codemirror -->
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.53.2/lib/codemirror.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.53.2/addon/mode/multiplex.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.53.2/addon/comment/comment.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.53.2/mode/markdown/markdown.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.53.2/mode/stex/stex.js"></script>
<script src="./codemirror-ipythongfm.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.53.2/lib/codemirror.css">

<!-- lib: katex -->
<script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css">

<!-- main script -->
<script>
  var kInput = document.querySelector('#input')
  var kOutput = document.querySelector('#output');
  var kKatexOptions = {
    output: 'html',
    throwOnError: false,
  };
  var kCodemirrorOptions = {
    mode: 'ipythongfm',
    tabSize: 2,
    indentWithTabs: false,
    lineNumbers: true,
    "extraKeys": {
      // Minimal emacs keybindings
      "Ctrl-B": "goCharLeft",
      "Ctrl-F": "goCharRight",
      "Ctrl-P": "goLineUp",
      "Ctrl-N": "goLineDown",
      "Ctrl-A": "goLineStart",
      "Ctrl-E": "goLineEnd",

      // Spaces for Tab (cf. https://github.com/codemirror/CodeMirror/issues/988)
      "Tab": (cm) => cm.execCommand("indentMore"),
      "Shift-Tab": (cm) => cm.execCommand("indentLess"),

      // Comment addon
      "Ctrl-/": (cm) => cm.toggleComment(),
    }
  };
  var kKatexCache = {};

  // Render math as Showdown extension
  showdown.extension('katex', () => [
    //
    // Strategy is
    //   - first 'lang' pass we wrap $...$ by custom script tag, so that Showdown ignores it internally.
    //   - second 'output' pass we render math via Katex.
    //
    // We don't render at 'lang' pass because katex's output dom string is quite complicated and
    // it seems that this increases what Showdown has to process internally.
    //
    // NOTE:
    // - For nested usage of "$" (e.g. $x = y \text{where $y = 1$} $), the inner one has to be replaced with "\( .. \)"
    // - Showdown treats "$" as "¨D"
    //
    {
      type: 'lang',
      regex: /(^|\s)¨D((?:(?!¨D)(?:.|\n))+)¨D($|\s)/gm, // find $ ... $
      replace: (...args) => {
        var [orig, m1, m2, m3] = args;
        return `${m1}<script type="math/tex; mode=inline">${m2}<\/script>${m3}`;
      }
    },
    {
      type: 'lang',
      regex: /(^|\s)¨D¨D((?:(?!¨D)(?:.|\n))+)¨D¨D($|\s)/gm, // find $$ ... $$
      replace: (...args) => {
        var [orig, m1, m2, m3] = args;
        return `${m1}<script type="math/tex; mode=display">${m2}<\/script>${m3}`;
      }
    },
    {
      type: 'output',
      regex: /<script type="math\/tex; mode=(.*?)">((?:.|\n)*?)<\/script>/gm,
      replace: (...args) => {
        var mode = args[1];
        var input = args[2];
        var key = `${input}@mode=${mode}`;
        if (!(key in kKatexCache)) {
          kKatexCache[key] = katex.renderToString(input, { displayMode: mode == 'display', ...kKatexOptions });
        }
        return kKatexCache[key];
      }
    },
  ]);
  var kConverter = new window.showdown.Converter({ extensions: ['katex'] });
  var kEditor = CodeMirror(kInput, kCodemirrorOptions);

  var preview = (src) => kOutput.innerHTML = kConverter.makeHtml(src);
  var throttledPreview = _.throttle(preview, 200, { leading: false, trailing : true });
  kEditor.doc.on('change', () => {
    throttledPreview(kEditor.getValue());
  });

  //
  // Use Gist as data storage
  //
  var kUrlQuery = _.fromPairs(window.location.search.substr(1).split('&').map(e => e.split('=')));
  var { id : kId, filename : kFilename } = kUrlQuery;
  var kToken = window.localStorage.getItem('token');

  var fetchToJson = (resp) => {
    if (!resp.ok) { throw resp.statusText; }
    return resp.json();
  }

  var gistGet = (id, token, filename) =>
    fetch('https://api.github.com/gists/' + id, {
      // if public, request will succeed without token
      headers: { Authorization: token ? `token ${token}` : null }
    }).then(fetchToJson).then((respJson) => {
      if (!(filename in respJson.files)) {
        throw `Gist not found : filename = ${filename}`;
      }
      return respJson.files[filename].content;
    });

  var gistUpdate = (id, token, filename, content) =>
    fetch('https://api.github.com/gists/' + id, {
      method: 'PATCH',
      headers: { Authorization: `token ${token}` },
      body: JSON.stringify({
        files: { [filename]: { content } }
      })
    }).then(fetchToJson);

  if (kId && kFilename) {
    // Load
    gistGet(kId, kToken, kFilename).then(
      (content) => kEditor.setValue(content), window.alert);

    // Update on Control-s (if token is valid)
    document.addEventListener('keydown', (event) => {
      if (event.ctrlKey && event.key == 's') {
        event.preventDefault();
        if (!kToken) {
          window.alert('Access token must be provided to save data');
          return;
        }
        gistUpdate(kId, kToken, kFilename, kEditor.getValue()).catch(window.alert);
      }
    });
  }

  document.querySelector('#current-gist > span').addEventListener('click', (event) => {
    const url = `https://gist.github.com/${kId}`;
    window.open(url, '_blank');
  });

  document.querySelector('#open-new-gist > span').addEventListener('click', (event) => {
    const example = `${kId || '<gist-id>'}/${kFilename || '<filename>'}`;
    const input = window.prompt('Input Gist ID and Filename', example);
    if (input) {
      const [id, filename] = input.split('/');
      const { origin, pathname } = window.location;
      window.location = `${origin}${pathname}?id=${id}&filename=${filename}`;
    }
  });

  document.querySelector('#setup-access-token > span').addEventListener('click', (event) => {
    const token = window.prompt('Input your access token');
    if (token) {
      window.localStorage.setItem('token', token);
      window.location.reload();
    }
  });
</script>
