<!DOCTYPE html>

<!-- css -->
<style>
  *, *::before, *::after {
    box-sizing: border-box;
    margin: 0; border: 0;
  }
  html, body {
    height: 100%;
  }
  #root {
    height: 100%;
    display: flex;
    flex-direction: row;
  }
  #input {
    flex: 1 0 50%;
    overflow-x: auto;
    border-right: 1px solid #aaa;
  }
  #input > .CodeMirror {
    height: 100%;
  }
  #output {
    flex: 1 0 50%;
    overflow-y: auto;
    padding: 10px;
  }
</style>

<!-- DOM -->
<div id="root">
  <div id="input"></div>
  <div id="output"></div>
</div>

<!-- lib: lodash -->
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>

<!-- lib: showdown -->
<script src="https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js"></script>

<!-- lib: codemirror -->
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.53.2/lib/codemirror.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.53.2/addon/mode/multiplex.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.53.2/mode/markdown/markdown.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.53.2/mode/stex/stex.js"></script>
<script src="./codemirror-ipythongfm.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.53.2/lib/codemirror.css">

<!-- lib: katex -->
<script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css">

<!-- main script -->
<script>
  var kInput = document.querySelector('#input')
  var kOutput = document.querySelector('#output');
  var kKatexOptions = {
    output: 'html',
    throwOnError: false,
  };
  var kCodemirrorOptions = {
    mode: 'ipythongfm',
    tabSize: 2,
    indentWithTabs: false,
    lineNumbers: true,
    "extraKeys": {
      // Minimal emacs keybindings
      "Ctrl-B": "goCharLeft",
      "Ctrl-F": "goCharRight",
      "Ctrl-P": "goLineUp",
      "Ctrl-N": "goLineDown",
      "Ctrl-A": "goLineStart",
      "Ctrl-E": "goLineEnd",

      // Spaces for Tab (cf. https://github.com/codemirror/CodeMirror/issues/988)
      "Tab": (cm) => cm.execCommand("indentMore"),
      "Shift-Tab": (cm) => cm.execCommand("indentLess"),
    }
  };
  var kKatexCache = {};

  // Render math as Showdown extension
  showdown.extension('katex', () => [
    //
    // Strategy is
    //   - first 'lang' pass we wrap $...$ by custom script tag, so that Showdown ignores it internally.
    //   - second 'output' pass we render math via Katex.
    //
    // We don't render at 'lang' pass because katex's output dom string is quite complicated and
    // it seems that this increases what Showdown has to process internally.
    //
    // NOTE:
    // - For nested usage of "$" (e.g. $x = y \text{where $y = 1$} $), the inner one has to be replaced with "\( .. \)"
    //
    {
      // NOTE: Showdown treats "$" as "¨D"
      type: 'lang',
      regex: /(^|\s)¨D((?:(?!¨D)(?:.|\n))+)¨D($|\s)/gm, // find $ ... $
      replace: (...args) => {
        var [orig, m1, m2, m3] = args;
        return `${m1}<script type="math/tex; mode=inline">${m2}<\/script>${m3}`;
      }
    },
    {
      type: 'lang',
      regex: /(^|\s)¨D¨D((?:(?!¨D)(?:.|\n))+)¨D¨D($|\s)/gm, // find $$ ... $$
      replace: (...args) => {
        var [orig, m1, m2, m3] = args;
        return `${m1}<script type="math/tex; mode=display">${m2}<\/script>${m3}`;
      }
    },
    {
      type: 'output',
      regex: /<script type="math\/tex; mode=(.*?)">((?:.|\n)*?)<\/script>/gm,
      replace: (...args) => {
        var mode = args[1];
        var input = args[2];
        var key = `${input}@mode=${mode}`;
        if (!(key in kKatexCache)) {
          kKatexCache[key] = katex.renderToString(input, { displayMode: mode == 'display', ...kKatexOptions });
        }
        return kKatexCache[key];
      }
    },
  ]);
  var kConverter = new window.showdown.Converter({ extensions: ['katex'] });
  var kEditor = CodeMirror(kInput, kCodemirrorOptions);

  var preview = (src) => kOutput.innerHTML = kConverter.makeHtml(src);
  var throttledPreview = _.throttle(preview, 200, { leading: false, trailing : true });
  kEditor.doc.on('change', () => {
    throttledPreview(kEditor.getValue());
  });

  //
  // Use Gist as data storage
  //
  var kGistUrl = 'https://api.github.com/gists';
  var kUrlQuery = _.fromPairs(window.location.search.substr(1).split('&').map(e => e.split('=')));

  var fetchToJson = (resp) => {
    if (!resp.ok) { throw resp.statusText; }
    return resp.json();
  }
  var gistGet = (id, token, filename) =>
    fetch('https://api.github.com/gists/' + id, {
      headers: { Authorization: `token ${token}` }
    }).then(fetchToJson).then((respJson) => {
      if (!(filename in respJson.files)) {
        throw `Gist (${filename}) not found.`;
      }
      return respJson.files[filename].content;
    });

  var gistUpdate = (id, token, filename, content) =>
    fetch('https://api.github.com/gists/' + id, {
      method: 'PATCH',
      headers: { Authorization: `token ${token}` },
      body: JSON.stringify({
        files: { [filename]: { content } }
      })
    }).then(fetchToJson);

  if (['id', 'token', 'filename'].every(e => e in kUrlQuery)) {
    const { id, token, filename } = kUrlQuery;

    // Load
    gistGet(id, token, filename).then(
      (content) => kEditor.setValue(content), window.alert);

    // Update on Control-s
    document.addEventListener('keydown', (event) => {
      if (event.ctrlKey && event.key == 's') {
        event.preventDefault();
        gistUpdate(id, token, filename, kEditor.getValue()).catch(window.alert);
      }
    });
  }
</script>
